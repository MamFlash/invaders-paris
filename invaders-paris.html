<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üëæ Invaders Paris</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root {
  --bg: #0a0a0f;
  --panel: #111118;
  --border: #1e1e2e;
  --accent: #00ff88;
  --accent2: #ff3366;
  --accent3: #ffcc00;
  --text: #e0e0f0;
  --muted: #555570;
  --flashed: #2a2a3a;
  --bottom-nav-h: 0px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; overflow: hidden; font-family: 'Syne', sans-serif; background: var(--bg); color: var(--text); }

/* ===================== DESKTOP ===================== */
.app { display: flex; flex-direction: column; height: 100vh; }

/* HEADER */
header {
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  padding: 10px 20px;
  display: flex; align-items: center; gap: 16px;
  flex-shrink: 0; z-index: 100;
}
.logo { font-size: 22px; font-weight: 800; color: var(--accent); text-shadow: 0 0 20px rgba(0,255,136,0.4); }
.logo span { color: var(--accent2); }
.stats-bar { display: flex; gap: 20px; margin-left: auto; font-family: 'Space Mono', monospace; font-size: 12px; }
.stat { text-align: center; }
.stat-value { color: var(--accent); font-size: 16px; font-weight: 700; display: block; }
.stat-value.red { color: var(--accent2); }
.stat-value.yellow { color: var(--accent3); }
.stat-label { color: var(--muted); font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }

/* MAIN */
.main { display: flex; flex: 1; overflow: hidden; }

/* SIDEBAR */
.sidebar {
  width: 320px; background: var(--panel);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  flex-shrink: 0; overflow: hidden;
}
.mode-tabs { display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.mode-tab {
  flex: 1; padding: 10px 6px; border: none; background: transparent;
  color: var(--muted); font-family: 'Syne', sans-serif; font-size: 11px;
  font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;
  border-bottom: 2px solid transparent; transition: all 0.2s;
}
.mode-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; }
.tab-content.active { display: flex; }

/* LISTE TAB */
.sidebar-controls { padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
.search-box {
  background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
  padding: 8px 12px; color: var(--text); font-family: 'Space Mono', monospace;
  font-size: 12px; width: 100%; outline: none; transition: border-color 0.2s;
}
.search-box:focus { border-color: var(--accent); }
.search-box::placeholder { color: var(--muted); }
.filter-row { display: flex; gap: 6px; flex-wrap: wrap; }
.toggle-btn {
  padding: 5px 10px; border-radius: 4px; border: 1px solid var(--border);
  background: transparent; color: var(--muted); font-family: 'Space Mono', monospace;
  font-size: 10px; cursor: pointer; transition: all 0.2s;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.toggle-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); font-weight: 700; }
.toggle-btn.red.active { background: var(--accent2); border-color: var(--accent2); }
.toggle-btn.yellow.active { background: var(--accent3); border-color: var(--accent3); color: #000; }
.uid-row { display: flex; gap: 6px; }
.uid-input {
  flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
  padding: 7px 10px; color: var(--text); font-family: 'Space Mono', monospace; font-size: 11px; outline: none;
}
.uid-input:focus { border-color: var(--accent3); }
.uid-input::placeholder { color: var(--muted); font-size: 10px; }
.btn {
  padding: 7px 12px; border-radius: 6px; border: none; background: var(--accent); color: var(--bg);
  font-family: 'Syne', sans-serif; font-size: 11px; font-weight: 700; cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.btn:hover { filter: brightness(1.2); }
.btn.danger { background: var(--accent2); color: #fff; }
.btn.yellow { background: var(--accent3); color: #000; }
.btn.gray { background: var(--border); color: var(--text); }
.section-title { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--muted); padding: 10px 16px 6px; border-bottom: 1px solid var(--border); }
.invader-list { flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
.invader-item {
  display: flex; align-items: center; gap: 10px; padding: 10px 14px;
  border-bottom: 1px solid rgba(30,30,46,0.5); cursor: pointer; transition: background 0.15s;
}
.invader-item:hover { background: rgba(0,255,136,0.04); }
.invader-item.flashed { opacity: 0.4; background: var(--flashed); }
.invader-item.active { background: rgba(0,255,136,0.08); border-left: 2px solid var(--accent); }
.item-thumb-placeholder { width: 36px; height: 36px; border-radius: 4px; background: var(--border); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; }
.item-info { flex: 1; min-width: 0; }
.item-id { font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700; color: var(--accent); }
.item-id.destroyed { color: var(--accent2); }
.item-status { font-size: 10px; color: var(--muted); margin-top: 1px; }
.flash-toggle {
  width: 28px; height: 28px; border-radius: 50%; border: 1.5px solid var(--border);
  background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center;
  font-size: 14px; transition: all 0.2s; flex-shrink: 0;
}
.flash-toggle:hover { border-color: var(--accent3); }
.flash-toggle.done { background: rgba(255,204,0,0.15); border-color: var(--accent3); }
.import-section { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 6px; }
.import-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
.import-row { display: flex; gap: 6px; }

/* BALADE TAB */
.balade-controls { padding: 12px 14px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; }
.balade-row { display: flex; gap: 6px; align-items: center; }
.balade-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; min-width: 60px; }
.range-input { flex: 1; accent-color: var(--accent); cursor: pointer; }
.range-value { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--accent); min-width: 40px; text-align: right; }
.balade-summary { padding: 10px 14px; background: rgba(0,255,136,0.04); border-bottom: 1px solid var(--border); font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); display: none; }
.balade-summary.visible { display: block; }
.balade-summary strong { color: var(--accent); }
.balade-list { flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
.balade-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-bottom: 1px solid rgba(30,30,46,0.5); cursor: pointer; transition: background 0.15s; }
.balade-item:hover { background: rgba(0,255,136,0.04); }
.balade-item.current { background: rgba(0,255,136,0.1); border-left: 2px solid var(--accent); }
.balade-item.done-step { opacity: 0.4; }
.step-num { width: 24px; height: 24px; border-radius: 50%; background: var(--border); display: flex; align-items: center; justify-content: center; font-family: 'Space Mono', monospace; font-size: 10px; font-weight: 700; color: var(--muted); flex-shrink: 0; }
.step-num.current-num { background: var(--accent); color: var(--bg); }
.step-num.done-num { background: rgba(0,255,136,0.2); color: var(--accent); }
.step-info { flex: 1; min-width: 0; }
.step-id { font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700; color: var(--accent); }
.step-dist { font-size: 10px; color: var(--muted); margin-top: 1px; }
.balade-actions { padding: 12px 14px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 6px; flex-shrink: 0; }

/* MAP */
#map { flex: 1; z-index: 1; }
.grayscale-tiles { filter: invert(1) hue-rotate(180deg) brightness(0.7) contrast(0.9) saturate(0.3); }

/* POPUP */
.popup-card { font-family: 'Syne', sans-serif; min-width: 200px; max-width: 260px; }
.popup-img { width: 100%; height: 140px; object-fit: cover; border-radius: 6px; margin-bottom: 10px; background: #222; cursor: pointer; }
.popup-id { font-family: 'Space Mono', monospace; font-weight: 700; font-size: 15px; color: #00ff88; margin-bottom: 4px; }
.popup-status { font-size: 11px; color: #888; margin-bottom: 10px; }
.popup-flash-btn { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ffcc00; background: rgba(255,204,0,0.1); color: #ffcc00; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; transition: all 0.2s; text-align: center; }
.popup-flash-btn:hover { background: rgba(255,204,0,0.25); }
.popup-flash-btn.flashed { background: rgba(255,204,0,0.2); border-color: rgba(255,204,0,0.4); }

/* NAV OVERLAY */
.nav-overlay {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  background: var(--panel); border: 1px solid var(--accent); border-radius: 16px;
  padding: 14px 20px; z-index: 2000; display: none; flex-direction: column;
  align-items: center; gap: 8px; box-shadow: 0 8px 30px rgba(0,255,136,0.2);
  min-width: 280px; max-width: 90vw;
}
.nav-overlay.visible { display: flex; }
.nav-invader-id { font-family: 'Space Mono', monospace; font-size: 18px; font-weight: 700; color: var(--accent); }
.nav-distance { font-size: 12px; color: var(--muted); }
.nav-hint { font-size: 11px; color: #aaa; font-style: italic; }
.nav-buttons { display: flex; gap: 8px; margin-top: 4px; }
.nav-btn { padding: 8px 16px; border-radius: 8px; border: none; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 12px; cursor: pointer; transition: all 0.2s; }
.nav-btn.flash { background: var(--accent3); color: #000; }
.nav-btn.skip { background: var(--border); color: var(--text); }
.nav-btn.stop { background: var(--accent2); color: #fff; }
.nav-progress { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--muted); }
.pos-marker { width: 16px; height: 16px; border-radius: 50%; background: #4af; border: 3px solid #fff; box-shadow: 0 0 12px #4af; }

/* INSTAGRAM PANEL */
.ig-panel {
  position: fixed; right: 0; top: 0; bottom: 0; width: 380px;
  background: var(--panel); border-left: 1px solid var(--border);
  z-index: 2000; display: flex; flex-direction: column;
  transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: -8px 0 30px rgba(0,0,0,0.5);
}
.ig-panel.open { transform: translateX(0); }
.ig-panel-header { padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.ig-panel-title { font-size: 13px; font-weight: 700; color: var(--text); flex: 1; }
.ig-panel-id { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--accent); }
.ig-close { background: none; border: none; color: var(--muted); font-size: 18px; cursor: pointer; padding: 2px 6px; border-radius: 4px; transition: color 0.2s; }
.ig-close:hover { color: var(--text); }
.ig-frame-wrap { flex: 1; overflow: hidden; background: #000; display: flex; align-items: center; justify-content: center; }
.ig-open-btn { padding: 14px 16px; border-top: 1px solid var(--border); flex-shrink: 0; }
.ig-open-btn a { display: block; text-align: center; padding: 10px; border-radius: 6px; background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045); color: #fff; font-weight: 700; font-size: 13px; text-decoration: none; transition: opacity 0.2s; }
.ig-open-btn a:hover { opacity: 0.85; }

/* LOADING */
.loading-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
.loading-title { font-size: 32px; font-weight: 800; color: var(--accent); text-shadow: 0 0 30px rgba(0,255,136,0.5); animation: pulse 1.5s ease-in-out infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
.loading-sub { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--muted); text-align: center; line-height: 1.8; }
.progress-bar { width: 280px; height: 2px; background: var(--border); border-radius: 2px; overflow: hidden; }
.progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; box-shadow: 0 0 8px var(--accent); }

/* NOTIFICATION */
.notif { position: fixed; bottom: calc(24px + var(--bottom-nav-h)); right: 24px; background: var(--panel); border: 1px solid var(--accent); border-radius: 8px; padding: 12px 18px; font-family: 'Space Mono', monospace; font-size: 12px; color: var(--accent); z-index: 9999; transform: translateY(80px); opacity: 0; transition: all 0.3s; max-width: 300px; }
.notif.show { transform: translateY(0); opacity: 1; }
.notif.error { border-color: var(--accent2); color: var(--accent2); }

/* LEAFLET */
.leaflet-popup-content-wrapper { background: #111118 !important; border: 1px solid #1e1e2e !important; border-radius: 10px !important; box-shadow: 0 8px 30px rgba(0,0,0,0.6) !important; }
.leaflet-popup-tip { background: #111118 !important; }
.leaflet-popup-content { margin: 14px !important; }

/* SCROLLBARS */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* BOTTOM NAV ‚Äî desktop: cach√© */
.bottom-nav { display: none; }
.sidebar-backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2999; }
.sidebar-backdrop.visible { display: block; }

/* ===================== MOBILE ===================== */
@media (max-width: 768px) {
  :root { --bottom-nav-h: 60px; }

  /* Header compact */
  header { padding: 8px 12px; gap: 0; flex-wrap: nowrap; }
  .logo { font-size: 14px; flex: 1; }
  .stats-bar { gap: 12px; margin-left: 8px; }
  .stat-value { font-size: 13px; }
  .stat-label { font-size: 8px; }

  /* Body adapt√© */
  body { height: 100dvh; }
  .app { height: 100dvh; }

  /* Main = carte full screen */
  .main { position: relative; flex: 1; }
  #map { position: absolute; inset: 0; width: 100%; height: 100%; }

  /* Sidebar = tiroir depuis le bas */
  .sidebar {
    position: fixed !important;
    left: 0; right: 0;
    bottom: var(--bottom-nav-h);
    top: auto !important;
    width: 100% !important;
    max-width: 100% !important;
    height: 75dvh;
    border-radius: 18px 18px 0 0;
    border-right: none;
    border-top: 2px solid var(--border);
    transform: translateY(100%);
    transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 3000;
    overflow: hidden;
  }
  .sidebar.open { transform: translateY(0); }

  /* Poign√©e en haut du tiroir */
  .sidebar::before {
    content: '';
    display: block;
    width: 40px; height: 4px;
    background: var(--muted);
    border-radius: 2px;
    margin: 10px auto 2px;
  }

  /* Bottom nav */
  .bottom-nav {
    display: flex !important;
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: var(--bottom-nav-h);
    background: var(--panel);
    border-top: 1px solid var(--border);
    z-index: 4000;
    align-items: stretch;
    padding-bottom: env(safe-area-inset-bottom);
  }
  .bottom-nav-btn {
    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px;
    border: none; background: transparent; color: var(--muted);
    font-family: 'Syne', sans-serif; font-size: 9px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.3px; cursor: pointer;
    -webkit-tap-highlight-color: transparent; transition: color 0.2s;
  }
  .bottom-nav-btn .nav-icon { font-size: 20px; line-height: 1; }
  .bottom-nav-btn.active { color: var(--accent); }

  /* Nav overlay au dessus de la bottom nav */
  .nav-overlay {
    bottom: calc(var(--bottom-nav-h) + 10px);
    left: 10px; right: 10px;
    transform: none; min-width: unset;
  }

  /* Instagram panel full width */
  .ig-panel { width: 100%; bottom: var(--bottom-nav-h); }

  /* Notification au dessus de la bottom nav */
  .notif { right: 12px; bottom: calc(var(--bottom-nav-h) + 10px); }

  /* Popup plus compacte */
  .popup-img { height: 120px; }
}
</style>
</head>
<body>
<div class="app">

<!-- LOADING -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-title">üëæ INVADERS PARIS</div>
  <div class="loading-sub" id="loadingMsg">Chargement‚Ä¶</div>
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
</div>

<!-- HEADER -->
<header>
  <div class="logo">üëæ INVADERS <span>PARIS</span></div>
  <div class="stats-bar">
    <div class="stat"><span class="stat-value" id="statTotal">0</span><span class="stat-label">Total</span></div>
    <div class="stat"><span class="stat-value yellow" id="statFlashed">0</span><span class="stat-label">Flash√©s</span></div>
    <div class="stat"><span class="stat-value" id="statRemaining">0</span><span class="stat-label">Restants</span></div>
    <div class="stat"><span class="stat-value red" id="statDestroyed">0</span><span class="stat-label">D√©truits</span></div>
  </div>
</header>

<div class="main">

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="mode-tabs">
      <button class="mode-tab active" onclick="switchTab('liste', this)">üó∫ Liste</button>
      <button class="mode-tab" onclick="switchTab('balade', this)">üö∂ Balade</button>
    </div>

    <!-- LISTE -->
    <div class="tab-content active" id="tab-liste">
      <div class="sidebar-controls">
        <input type="text" class="search-box" id="searchInput" placeholder="üîç Chercher un ID (PA_xxx)‚Ä¶">
        <div class="filter-row">
          <button class="toggle-btn active" data-filter="all" onclick="setFilter('all', this)">Tous</button>
          <button class="toggle-btn" data-filter="ok" onclick="setFilter('ok', this)">‚úÖ OK</button>
          <button class="toggle-btn yellow" data-filter="damaged" onclick="setFilter('damaged', this)">‚ö†Ô∏è</button>
          <button class="toggle-btn red" data-filter="destroyed" onclick="setFilter('destroyed', this)">üíÄ</button>
          <button class="toggle-btn" data-filter="notflashed" onclick="setFilter('notflashed', this)">üéØ Restants</button>
        </div>
        <div class="uid-row">
          <input type="text" class="uid-input" id="uidInput" placeholder="UID Flash Invaders (optionnel)">
          <button class="btn yellow" onclick="loadFromUID()">Sync</button>
        </div>
      </div>
      <div class="section-title" id="listCount">LISTE ‚Äî 0 invaders</div>
      <div class="invader-list" id="invaderList"></div>
      <div class="import-section">
        <span class="import-label">Sauvegarde</span>
        <div class="import-row">
          <button class="btn gray" style="flex:1" onclick="exportFlashed()">‚¨á Export</button>
          <label class="btn gray" style="flex:1; text-align:center; cursor:pointer">
            ‚¨Ü Import
            <input type="file" accept=".json" style="display:none" onchange="importFlashed(event)">
          </label>
          <button class="btn danger" onclick="resetFlashed()">Reset</button>
        </div>
      </div>
    </div>

    <!-- BALADE -->
    <div class="tab-content" id="tab-balade">
      <div class="balade-controls">
        <div class="balade-row">
          <span class="balade-label">Rayon</span>
          <input type="range" class="range-input" id="baladeRadius" min="300" max="3000" step="100" value="800" oninput="updateBaladeRadius()">
          <span class="range-value" id="baladeRadiusVal">800m</span>
        </div>
        <div class="balade-row">
          <span class="balade-label">Stops</span>
          <input type="range" class="range-input" id="baladeMax" min="3" max="30" step="1" value="10" oninput="updateBaladeMax()">
          <span class="range-value" id="baladeMaxVal">10</span>
        </div>
        <div style="display:flex; gap:6px; margin-top:4px;">
          <button class="btn" style="flex:1; font-size:11px;" onclick="planifierBalade()">üìç Ma position</button>
          <button class="btn gray" style="flex:1; font-size:11px;" onclick="planifierBaladeDepuisCarte()">üó∫ Depuis carte</button>
        </div>
      </div>
      <div class="balade-summary" id="baladeSummary"></div>
      <div class="balade-list" id="baladeList"></div>
      <div class="balade-actions" id="baladeActions" style="display:none">
        <button class="btn" style="background:var(--accent);color:var(--bg);" onclick="startNavigation()">‚ñ∂ D√©marrer la navigation</button>
        <button class="btn gray" onclick="resetBalade()">‚úï Effacer la balade</button>
      </div>
    </div>
  </div>

  <!-- MAP -->
  <div id="map"></div>
</div>

<!-- BOTTOM NAV (mobile uniquement) -->
<nav class="bottom-nav">
  <button class="bottom-nav-btn active" id="bnMap" onclick="bottomNav('map')">
    <span class="nav-icon">üó∫</span><span>Carte</span>
  </button>
  <button class="bottom-nav-btn" id="bnSearch" onclick="bottomNav('search')">
    <span class="nav-icon">üîç</span><span>Recherche</span>
  </button>
  <button class="bottom-nav-btn" id="bnBalade" onclick="bottomNav('balade')">
    <span class="nav-icon">üö∂</span><span>Balade</span>
  </button>
  <button class="bottom-nav-btn" id="bnFlash" onclick="bottomNav('flash')">
    <span class="nav-icon">‚≠ê</span><span>Restants</span>
  </button>
</nav>

<!-- BACKDROP -->
<div class="sidebar-backdrop" id="sidebarBackdrop" onclick="closeSidebar()"></div>

<!-- NAV OVERLAY -->
<div class="nav-overlay" id="navOverlay">
  <div class="nav-progress" id="navProgress">√âtape 1 / 10</div>
  <div class="nav-invader-id" id="navId">PA_xxx</div>
  <div class="nav-hint" id="navHint"></div>
  <div class="nav-distance" id="navDist">üìç Calcul en cours‚Ä¶</div>
  <div class="nav-buttons">
    <button class="nav-btn flash" onclick="navFlash()">‚≠ê Flash√© !</button>
    <button class="nav-btn skip" onclick="navSkip()">‚è≠ Passer</button>
    <button class="nav-btn stop" onclick="stopNavigation()">‚èπ Stop</button>
  </div>
</div>

<!-- INSTAGRAM PANEL -->
<div class="ig-panel" id="igPanel">
  <div class="ig-panel-header">
    <div style="font-size:20px">üì∏</div>
    <div>
      <div class="ig-panel-title">Photos Instagram</div>
      <div class="ig-panel-id" id="igPanelId"></div>
    </div>
    <button class="ig-close" onclick="closeIgPanel()">‚úï</button>
  </div>
  <div class="ig-frame-wrap" id="igFrameWrap">
    <div style="color:#555; font-size:13px; text-align:center; padding:20px; font-family:'Space Mono',monospace;">
      S√©lectionne un invader pour voir les photos
    </div>
  </div>
  <div class="ig-open-btn">
    <a id="igOpenLink" href="#" target="_blank">‚Üó Ouvrir sur Instagram</a>
  </div>
</div>

<!-- NOTIFICATION -->
<div class="notif" id="notif"></div>

</div><!-- end .app -->

<script>
// ===== STATE =====
let imageMap = {}; // PA_xxx ‚Üí URL photo
let allInvaders = [];
let flashed = new Set(JSON.parse(localStorage.getItem('flashedInvaders') || '[]'));
let currentFilter = 'all';
let searchTerm = '';
let map, markers = {};
let activeItem = null;

// ===== INIT =====
async function init() {
  await initMap();
  await loadData();
}

async function initMap() {
  map = L.map('map', { center: [48.8566, 2.3522], zoom: 14 });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    className: 'grayscale-tiles'
  }).addTo(map);

  // Apply dark/grayscale filter to tiles
  const style = document.createElement('style');
  style.textContent = `.grayscale-tiles { filter: invert(1) hue-rotate(180deg) brightness(0.7) contrast(0.9) saturate(0.3); }`;
  document.head.appendChild(style);
}

// ===== DATA LOADING =====
function showLocalFileInstructions() {
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed; inset: 0; background: rgba(10,10,15,0.92);
    z-index: 9998; display: flex; align-items: center; justify-content: center;
  `;
  overlay.innerHTML = `
    <div style="
      background: #111118; border: 1px solid #ffcc00; border-radius: 12px;
      padding: 32px; max-width: 480px; font-family: 'Syne', sans-serif; color: #e0e0f0;
    ">
      <div style="font-size:24px; font-weight:800; color:#ffcc00; margin-bottom:12px;">
        ‚ö†Ô∏è Fichier de donn√©es manquant
      </div>
      <p style="font-size:14px; line-height:1.7; color:#aaa; margin-bottom:20px;">
        Pour afficher les 1600+ invaders de Paris, tu dois placer le fichier 
        <code style="background:#1e1e2e; padding:2px 6px; border-radius:4px; color:#00ff88;">invaders.json</code>
        dans le <strong style="color:#fff">m√™me dossier</strong> que cette application.
      </p>
      <div style="background:#0a0a0f; border-radius:8px; padding:16px; margin-bottom:20px; font-size:13px; line-height:2;">
        <strong style="color:#00ff88;">√âtape 1</strong> ‚Äî Ouvre ce lien dans Chrome et fais <kbd style="background:#1e1e2e; padding:2px 6px; border-radius:3px;">Cmd+S</kbd> :<br>
        <a href="https://pnote.eu/projects/invaders/map/invaders.json?nocache=1" target="_blank"
           style="color:#ffcc00; word-break:break-all; font-size:11px;">
          https://pnote.eu/projects/invaders/map/invaders.json
        </a><br><br>
        <strong style="color:#00ff88;">√âtape 2</strong> ‚Äî Renomme le fichier en <code style="background:#1e1e2e; padding:2px 6px; border-radius:4px; color:#fff;">invaders.json</code><br><br>
        <strong style="color:#00ff88;">√âtape 3</strong> ‚Äî Mets-le dans le m√™me dossier que <code style="background:#1e1e2e; padding:2px 6px; border-radius:4px; color:#fff;">invaders-paris.html</code><br><br>
        <strong style="color:#00ff88;">√âtape 4</strong> ‚Äî Recharge la page (<kbd style="background:#1e1e2e; padding:2px 6px; border-radius:3px;">Cmd+R</kbd>)
      </div>
      <div style="display:flex; gap:10px;">
        <button onclick="this.closest('div[style]').parentElement.remove()" style="
          flex:1; padding:10px; border-radius:6px; border:none;
          background:#1e1e2e; color:#aaa; font-family:'Syne',sans-serif;
          font-size:13px; cursor:pointer;
        ">Continuer avec la d√©mo (29 invaders)</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}
async function loadData() {
  setProgress(10, 'Chargement du fichier local invaders.json‚Ä¶');
  // Load images.json if available
  try {
    const r = await fetch('./images.json');
    if (r.ok) { imageMap = await r.json(); console.log(`üì∏ ${Object.keys(imageMap).length} photos charg√©es`); }
  } catch(e) {}

  // Strategy 1: local file in same folder (best ‚Äî no CORS)
  let data = await tryLoadLocal();

  if (!data || data.length === 0) {
    setProgress(30, 'Fichier local non trouv√© ‚Äî tentative pnote.eu‚Ä¶');
    data = await tryLoadPnote();
  }

  if (!data || data.length === 0) {
    setProgress(60, 'pnote.eu bloqu√©. Donn√©es de d√©mo (29 invaders)‚Ä¶');
    data = getDemoData();
    showLocalFileInstructions();
  }

  setProgress(80, `${data.length} invaders charg√©s ‚Äî rendu de la carte‚Ä¶`);
  allInvaders = data;

  await renderAll();
  setProgress(100, 'Pr√™t !');

  setTimeout(() => {
    document.getElementById('loadingOverlay').style.display = 'none';
  }, 400);
}

async function tryLoadLocal() {
  // Tries to load invaders.json from the same folder as this HTML file
  try {
    const r = await fetch('./invaders.json', { signal: AbortSignal.timeout(5000) });
    if (r.ok) {
      const json = await r.json();
      const parsed = parsePnoteData(json);
      if (parsed.length > 0) {
        setProgress(70, `‚úÖ ${parsed.length} invaders charg√©s depuis le fichier local !`);
        return parsed;
      }
    }
  } catch(e) { /* file not present */ }
  return null;
}

async function tryLoadPnote() {
  const url = `https://pnote.eu/projects/invaders/map/invaders.json?nocache=${Date.now()}`;
  try {
    const r = await fetch(url, { mode: 'cors', signal: AbortSignal.timeout(10000) });
    if (r.ok) {
      const json = await r.json();
      const parsed = parsePnoteData(json);
      if (parsed.length > 0) return parsed;
    }
  } catch(e) { /* CORS blocked */ }
  return null;
}

async function tryLoadInvaderSpotter() {
  try {
    const r = await fetch('https://www.invader-spotter.art/api/invaders?city=paris&limit=2000', {
      mode: 'cors', signal: AbortSignal.timeout(5000)
    });
    if (r.ok) {
      const json = await r.json();
      return parseInvaderSpotterData(json);
    }
  } catch(e) {}
  return null;
}

function parsePnoteData(json) {
  if (!Array.isArray(json)) return [];
  // Garde uniquement Paris (IDs commencent par PA_)
  return json
    .filter(d => d.id && d.id.startsWith('PA_') && d.obf_lat && d.obf_lng)
    .map(d => ({
      id: d.id,
      lat: d.obf_lat,
      lng: d.obf_lng,
      status: (d.status || 'OK').toLowerCase(),
      hint: d.hint || null,
      instagramUrl: d.instagramUrl || null,
      img: getImgUrl(d.id),
      city: 'Paris'
    }));
}

function parseInvaderSpotterData(json) {
  if (!json || !json.data) return [];
  return json.data.map(d => ({
    id: d.reference || d.id,
    lat: parseFloat(d.lat),
    lng: parseFloat(d.lng),
    status: d.status || 'ok',
    points: d.points || 10,
    img: d.image || getImgUrl(d.reference),
    city: 'Paris'
  })).filter(d => d.lat && d.lng);
}

function getImgUrl(id) {
  if (!id) return null;
  // Use imageMap if loaded from images.json
  if (imageMap && imageMap[id]) return imageMap[id];
  return null;
}

// Demo data ‚Äî a sample of real Paris invaders with approximate coords
function getDemoData() {
  const parisInvaders = [
    { id: 'PA_001', lat: 48.8551, lng: 2.3507, status: 'ok', points: 10 },
    { id: 'PA_002', lat: 48.8548, lng: 2.3493, status: 'ok', points: 10 },
    { id: 'PA_010', lat: 48.8538, lng: 2.3489, status: 'ok', points: 10 },
    { id: 'PA_020', lat: 48.8603, lng: 2.3528, status: 'ok', points: 20 },
    { id: 'PA_030', lat: 48.8520, lng: 2.3415, status: 'ok', points: 10 },
    { id: 'PA_050', lat: 48.8612, lng: 2.3499, status: 'destroyed', points: 10 },
    { id: 'PA_075', lat: 48.8567, lng: 2.3587, status: 'ok', points: 20 },
    { id: 'PA_100', lat: 48.8580, lng: 2.3610, status: 'ok', points: 30 },
    { id: 'PA_150', lat: 48.8490, lng: 2.3580, status: 'damaged', points: 10 },
    { id: 'PA_200', lat: 48.8650, lng: 2.3460, status: 'ok', points: 20 },
    { id: 'PA_250', lat: 48.8715, lng: 2.3350, status: 'ok', points: 10 },
    { id: 'PA_300', lat: 48.8430, lng: 2.3650, status: 'ok', points: 20 },
    { id: 'PA_350', lat: 48.8785, lng: 2.3290, status: 'destroyed', points: 10 },
    { id: 'PA_400', lat: 48.8710, lng: 2.3680, status: 'ok', points: 30 },
    { id: 'PA_450', lat: 48.8395, lng: 2.3785, status: 'ok', points: 20 },
    { id: 'PA_500', lat: 48.8480, lng: 2.3210, status: 'damaged', points: 10 },
    { id: 'PA_550', lat: 48.8830, lng: 2.3490, status: 'ok', points: 20 },
    { id: 'PA_600', lat: 48.8325, lng: 2.3680, status: 'ok', points: 30 },
    { id: 'PA_700', lat: 48.8620, lng: 2.3820, status: 'ok', points: 10 },
    { id: 'PA_800', lat: 48.8750, lng: 2.3750, status: 'ok', points: 20 },
    { id: 'PA_900', lat: 48.8290, lng: 2.3540, status: 'ok', points: 20 },
    { id: 'PA_1000', lat: 48.8680, lng: 2.3090, status: 'ok', points: 50 },
    { id: 'PA_1100', lat: 48.8570, lng: 2.4050, status: 'ok', points: 10 },
    { id: 'PA_1200', lat: 48.8950, lng: 2.3690, status: 'destroyed', points: 20 },
    { id: 'PA_1300', lat: 48.8190, lng: 2.3490, status: 'ok', points: 10 },
    { id: 'PA_1400', lat: 48.8640, lng: 2.3190, status: 'ok', points: 10 },
    { id: 'PA_1431', lat: 48.8584, lng: 2.2945, status: 'ok', points: 100 }, // Tour Eiffel
    { id: 'PA_1500', lat: 48.8710, lng: 2.4150, status: 'ok', points: 20 },
    { id: 'PA_1529', lat: 48.8555, lng: 2.3460, status: 'ok', points: 30 },
  ];

  return parisInvaders.map(d => ({
    ...d,
    img: getImgUrl(d.id),
    city: 'Paris'
  }));
}

// ===== RENDER =====
async function renderAll() {
  renderList();
  renderMarkers();
  updateStats();
}

function renderList() {
  const list = document.getElementById('invaderList');
  const filtered = getFiltered();
  document.getElementById('listCount').textContent = `LISTE ‚Äî ${filtered.length} invaders`;

  list.innerHTML = '';
  filtered.forEach(inv => {
    const isFlashed = flashed.has(inv.id);
    const div = document.createElement('div');
    div.className = `invader-item ${isFlashed ? 'flashed' : ''}`;
    div.dataset.id = inv.id;
    div.innerHTML = `
      <div class="item-thumb-placeholder" title="${inv.id}">
        ${statusEmoji(inv.status)}
      </div>
      <div class="item-info">
        <div class="item-id ${inv.status === 'destroyed' ? 'destroyed' : ''}">${inv.id}</div>
        <div class="item-status">${statusLabel(inv.status)}${inv.points ? ` ‚Ä¢ ${inv.points}pts` : ''}</div>
      </div>
      <button class="flash-toggle ${isFlashed ? 'done' : ''}" onclick="toggleFlash(event, '${inv.id}')" title="Marquer comme flash√©">
        ${isFlashed ? '‚≠ê' : '‚òÜ'}
      </button>
    `;
    div.addEventListener('click', () => {
    focusInvader(inv.id);
    if (isMobile()) closeSidebar();
  });
    list.appendChild(div);
  });
}

function renderMarkers() {
  // Clear existing
  Object.values(markers).forEach(m => m.remove());
  markers = {};

  const filtered = getFiltered();
  filtered.forEach(inv => {
    const isFlashed = flashed.has(inv.id);
    const color = isFlashed ? '#444466' :
      inv.status === 'destroyed' ? '#ff3366' :
      inv.status === 'damaged' ? '#ffcc00' : '#00ff88';

    const size = 12;
    const icon = L.divIcon({
      html: `<div style="
        width:${size}px; height:${size}px; 
        border-radius: 50%;
        background: ${color};
        border: 2px solid ${color};
        box-shadow: 0 0 ${isFlashed ? 0 : 8}px ${color};
        opacity: ${isFlashed ? 0.4 : 1};
        transition: all 0.2s;
      "></div>`,
      className: '',
      iconSize: [size, size],
      iconAnchor: [size/2, size/2]
    });

    const marker = L.marker([inv.lat, inv.lng], { icon })
      .addTo(map);

    marker.on('click', () => {
      showPopup(inv, marker);
    });

    markers[inv.id] = marker;
  });
}

function showPopup(inv, marker) {
  const isFlashed = flashed.has(inv.id);

  const hasImg = inv.img && imageMap[inv.id];
  const popupContent = `
    <div class="popup-card">
      ${hasImg ? `
        <img class="popup-img"
          src="${inv.img}"
          onerror="this.style.display='none'"
          alt="${inv.id}"
          style="cursor:pointer"
          onclick="window.open('${inv.instagramUrl || '#'}', '_blank')"
        />
      ` : `
        <div style="width:100%; height:70px; background:#1e1e2e; border-radius:6px; margin-bottom:10px; display:flex; align-items:center; justify-content:center; font-size:28px;">üëæ</div>
      `}
      <div class="popup-id">${inv.id}</div>
      <div class="popup-status">${statusLabel(inv.status)}</div>
      ${inv.hint ? `<div style="font-size:11px;color:#aaa;margin-bottom:8px;font-style:italic;">${inv.hint}</div>` : ''}
      ${!hasImg && inv.instagramUrl ? `
        <a href="${inv.instagramUrl}" target="_blank" style="
          display:block; width:100%; padding:8px; border-radius:6px;
          border:1px solid #444; background:rgba(131,58,180,0.15);
          color:#cc88ff; font-family:'Syne',sans-serif; font-weight:700;
          font-size:12px; margin-bottom:8px; text-align:center;
          text-decoration:none; transition:all 0.2s;
        ">üì∏ Voir sur Instagram</a>
      ` : ''}
      <button class="popup-flash-btn ${isFlashed ? 'flashed' : ''}" onclick="toggleFlash(event, '${inv.id}')">
        ${isFlashed ? '‚≠ê Flash√© !' : '‚òÜ Marquer comme flash√©'}
      </button>
    </div>
  `;

  marker.bindPopup(popupContent, { maxWidth: 280 }).openPopup();

  // Highlight list item
  document.querySelectorAll('.invader-item').forEach(el => el.classList.remove('active'));
  const listItem = document.querySelector(`.invader-item[data-id="${inv.id}"]`);
  if (listItem) {
    listItem.classList.add('active');
    listItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
  activeItem = inv.id;
}

function focusInvader(id) {
  const inv = allInvaders.find(i => i.id === id);
  if (!inv) return;
  map.setView([inv.lat, inv.lng], 17, { animate: true });
  if (markers[id]) {
    showPopup(inv, markers[id]);
  }
}

// ===== FILTERING =====
function getFiltered() {
  let list = allInvaders.filter(inv => inv.city === 'Paris' || inv.city === 'paris' || !inv.city);
  
  if (searchTerm) {
    list = list.filter(inv => inv.id.toLowerCase().includes(searchTerm));
  }

  if (currentFilter === 'ok') list = list.filter(inv => inv.status === 'ok');
  else if (currentFilter === 'damaged') list = list.filter(inv => inv.status === 'damaged');
  else if (currentFilter === 'destroyed') list = list.filter(inv => inv.status === 'destroyed');
  else if (currentFilter === 'notflashed') list = list.filter(inv => !flashed.has(inv.id));

  return list;
}

function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderAll();
}

document.getElementById('searchInput').addEventListener('input', e => {
  searchTerm = e.target.value.toLowerCase();
  renderAll();
});

// ===== FLASH TOGGLE =====
function toggleFlash(event, id) {
  event.stopPropagation();
  if (flashed.has(id)) {
    flashed.delete(id);
    notify(`${id} ‚Äî non flash√©`);
  } else {
    flashed.add(id);
    notify(`‚≠ê ${id} ‚Äî flash√© !`);
  }
  saveFlashed();
  renderAll();

  // Refresh popup if open
  const inv = allInvaders.find(i => i.id === id);
  if (inv && markers[id] && markers[id].isPopupOpen()) {
    markers[id].closePopup();
    setTimeout(() => showPopup(inv, markers[id]), 50);
  }
}

function saveFlashed() {
  localStorage.setItem('flashedInvaders', JSON.stringify([...flashed]));
  updateStats();
}

// ===== STATS =====
function updateStats() {
  const paris = allInvaders.filter(i => i.city === 'Paris' || i.city === 'paris' || !i.city);
  const total = paris.length;
  const numFlashed = paris.filter(i => flashed.has(i.id)).length;
  const destroyed = paris.filter(i => i.status === 'destroyed').length;

  document.getElementById('statTotal').textContent = total;
  document.getElementById('statFlashed').textContent = numFlashed;
  document.getElementById('statRemaining').textContent = total - numFlashed - destroyed;
  document.getElementById('statDestroyed').textContent = destroyed;
}

// ===== UID IMPORT =====
async function loadFromUID() {
  const uid = document.getElementById('uidInput').value.trim();
  if (!uid) { notify('Entre ton UID Flash Invaders', true); return; }

  notify('Synchronisation en cours‚Ä¶');
  try {
    // Flash Invaders API ‚Äî discovered by the community
    const r = await fetch(`https://api.space-invaders.com/user/${uid}/flashes`, {
      mode: 'cors', signal: AbortSignal.timeout(8000)
    });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();

    const ids = data.map ? data.map(f => f.invader_id || f.id || f.reference).filter(Boolean) : [];
    if (ids.length === 0) throw new Error('Aucun flash trouv√©');

    ids.forEach(id => flashed.add(id));
    saveFlashed();
    renderAll();
    notify(`‚úÖ ${ids.length} flashs import√©s depuis ton compte !`);
  } catch(e) {
    // Try alternate endpoint pattern
    try {
      const r2 = await fetch(`https://api.flash-invaders.com/user/flashes?uid=${uid}`, {
        mode: 'cors', signal: AbortSignal.timeout(5000)
      });
      if (r2.ok) {
        const d = await r2.json();
        notify(`‚úÖ Import√© depuis Flash Invaders`);
        return;
      }
    } catch(e2) {}
    notify(`L'API Flash Invaders est inaccessible directement.\nUtilise le script Python ci-dessous pour r√©cup√©rer tes flashs.`, true);
  }
}

// ===== EXPORT / IMPORT =====
function exportFlashed() {
  const data = { flashedInvaders: [...flashed], exportDate: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `invaders-paris-${Date.now()}.json`;
  a.click();
  notify('‚úÖ Export t√©l√©charg√©');
}

function importFlashed(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      const ids = data.flashedInvaders || data;
      if (Array.isArray(ids)) {
        ids.forEach(id => flashed.add(id));
        saveFlashed();
        renderAll();
        notify(`‚úÖ ${ids.length} flashs import√©s`);
      }
    } catch(err) { notify('Fichier JSON invalide', true); }
  };
  reader.readAsText(file);
}

function resetFlashed() {
  if (!confirm('R√©initialiser tous les flashs ?')) return;
  flashed.clear();
  saveFlashed();
  renderAll();
  notify('Flashs r√©initialis√©s');
}

// ===== UTILS =====
function statusEmoji(s) {
  if (s === 'destroyed') return 'üíÄ';
  if (s === 'damaged') return '‚ö†Ô∏è';
  return 'üëæ';
}
function statusLabel(s) {
  if (s === 'destroyed') return 'üíÄ D√©truit';
  if (s === 'damaged') return '‚ö†Ô∏è Endommag√©';
  return '‚úÖ OK';
}

function setProgress(pct, msg) {
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('loadingMsg').textContent = msg;
}

let notifTimer;
function notify(msg, isError = false) {
  const el = document.getElementById('notif');
  el.textContent = msg;
  el.className = 'notif show' + (isError ? ' error' : '');
  clearTimeout(notifTimer);
  notifTimer = setTimeout(() => el.className = 'notif', 3500);
}

// ===== INSTAGRAM PANEL =====
function openIgPanel(id, igUrl) {
  const panel = document.getElementById('igPanel');
  const frameWrap = document.getElementById('igFrameWrap');
  const openLink = document.getElementById('igOpenLink');

  document.getElementById('igPanelId').textContent = id;
  openLink.href = igUrl;

  // Show tag page embedded ‚Äî Instagram allows tag pages in iframes on some browsers
  // We use a tag search URL which is more likely to work
  const tag = id.toLowerCase().replace('_', '_');
  frameWrap.innerHTML = `
    <div style="
      display:flex; flex-direction:column; align-items:center; 
      justify-content:center; gap:16px; padding:30px; text-align:center;
    ">
      <div style="font-size:48px;">üì∏</div>
      <div style="font-family:'Space Mono',monospace; font-size:13px; color:#00ff88;">${id}</div>
      <div style="font-size:12px; color:#888; line-height:1.8;">
        Instagram bloque l'affichage direct.<br>
        Clique sur le bouton ci-dessous<br>pour voir les photos dans un nouvel onglet.
      </div>
      <a href="${igUrl}" target="_blank" style="
        padding:12px 20px; border-radius:8px;
        background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045);
        color:#fff; font-weight:700; font-size:13px; text-decoration:none;
        font-family:'Syne',sans-serif;
      ">Voir #${id.toLowerCase()} sur Instagram ‚Üó</a>
      <div style="font-size:10px; color:#444; font-family:'Space Mono',monospace; margin-top:8px;">
        cherche aussi : #spaceinvader${id.toLowerCase().replace('pa_','')}
      </div>
    </div>
  `;

  panel.classList.add('open');

  // Adjust map to not be hidden behind panel
  document.getElementById('map').style.marginRight = '380px';
}

function closeIgPanel() {
  document.getElementById('igPanel').classList.remove('open');
  document.getElementById('map').style.marginRight = '0';
}

// Close panel with Escape key
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeIgPanel();
});


// ===== BALADE MODE =====
let baladeRoute = [];       // liste ordonn√©e d'invaders pour la balade
let baladeRadius = 800;     // rayon en m√®tres
let baladeMax = 10;         // nombre max de stops
let baladeOrigin = null;    // {lat, lng} point de d√©part
let baladeCircle = null;    // cercle Leaflet
let baladeMarkers = [];     // marqueurs num√©rot√©s
let routePolyline = null;   // trait de l'itin√©raire

let navStep = 0;            // √©tape courante
let navActive = false;
let posMarker = null;       // marqueur position GPS
let watchId = null;         // GPS watch

// Tab switching
function switchTab(name, btn) {
  document.querySelectorAll('.mode-tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
}

function updateBaladeRadius() {
  baladeRadius = parseInt(document.getElementById('baladeRadius').value);
  document.getElementById('baladeRadiusVal').textContent = baladeRadius + 'm';
}
function updateBaladeMax() {
  baladeMax = parseInt(document.getElementById('baladeMax').value);
  document.getElementById('baladeMaxVal').textContent = baladeMax;
}

// Calcul distance entre deux points GPS (Haversine)
function distanceM(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function formatDist(m) {
  return m < 1000 ? Math.round(m) + 'm' : (m/1000).toFixed(1) + 'km';
}

// Algorithme greedy nearest-neighbor pour optimiser le parcours
function optimizeRoute(origin, invaders) {
  const candidates = invaders
    .filter(inv => !flashed.has(inv.id) && inv.status !== 'destroyed')
    .filter(inv => distanceM(origin.lat, origin.lng, inv.lat, inv.lng) <= baladeRadius)
    .slice(0, 80); // limite pour perf

  if (candidates.length === 0) return [];

  // Nearest neighbor greedy
  const route = [];
  const remaining = [...candidates];
  let current = origin;

  while (route.length < baladeMax && remaining.length > 0) {
    let nearestIdx = 0;
    let nearestDist = Infinity;
    remaining.forEach((inv, i) => {
      const d = distanceM(current.lat, current.lng, inv.lat, inv.lng);
      if (d < nearestDist) { nearestDist = d; nearestIdx = i; }
    });
    const nearest = remaining.splice(nearestIdx, 1)[0];
    nearest._dist = nearestDist;
    route.push(nearest);
    current = { lat: nearest.lat, lng: nearest.lng };
  }
  return route;
}

// Calcule la distance totale d'un parcours
function totalDistance(origin, route) {
  let total = 0;
  let prev = origin;
  route.forEach(inv => {
    total += distanceM(prev.lat, prev.lng, inv.lat, inv.lng);
    prev = inv;
  });
  return total;
}

function clearBaladeMapElements() {
  if (baladeCircle) { baladeCircle.remove(); baladeCircle = null; }
  baladeMarkers.forEach(m => m.remove());
  baladeMarkers = [];
  if (routePolyline) { routePolyline.remove(); routePolyline = null; }
}

function drawBalade(origin, route) {
  clearBaladeMapElements();

  // Cercle de rayon
  baladeCircle = L.circle([origin.lat, origin.lng], {
    radius: baladeRadius,
    color: '#00ff88',
    fillColor: '#00ff88',
    fillOpacity: 0.04,
    weight: 1,
    dashArray: '6,4'
  }).addTo(map);

  // Polyline du parcours
  const points = [[origin.lat, origin.lng], ...route.map(inv => [inv.lat, inv.lng])];
  routePolyline = L.polyline(points, {
    color: '#00ff88',
    weight: 2,
    opacity: 0.5,
    dashArray: '8,6'
  }).addTo(map);

  // Marqueurs num√©rot√©s
  route.forEach((inv, i) => {
    const icon = L.divIcon({
      html: `<div style="
        width:24px; height:24px; border-radius:50%;
        background: #ffcc00; color:#000;
        display:flex; align-items:center; justify-content:center;
        font-family:'Space Mono',monospace; font-size:10px; font-weight:700;
        border:2px solid #fff; box-shadow:0 2px 8px rgba(0,0,0,0.5);
      ">${i+1}</div>`,
      className: '', iconSize: [24,24], iconAnchor: [12,12]
    });
    const m = L.marker([inv.lat, inv.lng], { icon }).addTo(map);
    m.on('click', () => focusInvader(inv.id));
    baladeMarkers.push(m);
  });

  // Marqueur point de d√©part
  const startIcon = L.divIcon({
    html: `<div style="
      width:20px; height:20px; border-radius:50%;
      background:#4af; border:3px solid #fff;
      box-shadow:0 0 12px #4af;
    "></div>`,
    className: '', iconSize: [20,20], iconAnchor: [10,10]
  });
  const sm = L.marker([origin.lat, origin.lng], { icon: startIcon }).addTo(map);
  baladeMarkers.push(sm);

  // Fit map to route
  const allPoints = [[origin.lat, origin.lng], ...route.map(i => [i.lat, i.lng])];
  if (allPoints.length > 1) map.fitBounds(allPoints, { padding: [40,40] });
}

function renderBaladeList(origin, route) {
  const list = document.getElementById('baladeList');
  const summary = document.getElementById('baladeSummary');
  const actions = document.getElementById('baladeActions');

  if (route.length === 0) {
    list.innerHTML = `<div style="padding:20px; text-align:center; color:var(--muted); font-size:12px; font-family:'Space Mono',monospace;">
      Aucun invader non flash√© dans ce rayon.<br>Essaie d'augmenter le rayon !
    </div>`;
    summary.classList.remove('visible');
    actions.style.display = 'none';
    return;
  }

  const dist = totalDistance(origin, route);
  const walkMin = Math.round(dist / 80); // ~80m/min √† pied
  summary.innerHTML = `<strong>${route.length} invaders</strong> ¬∑ ${formatDist(dist)} ¬∑ ~${walkMin} min √† pied`;
  summary.classList.add('visible');
  actions.style.display = 'flex';

  list.innerHTML = '';
  route.forEach((inv, i) => {
    const div = document.createElement('div');
    div.className = 'balade-item';
    div.dataset.id = inv.id;
    div.innerHTML = `
      <div class="step-num">${i+1}</div>
      <div class="step-info">
        <div class="step-id">${inv.id}</div>
        <div class="step-dist">${formatDist(inv._dist || 0)} du point pr√©c√©dent${inv.hint ? ' ¬∑ ' + inv.hint : ''}</div>
      </div>
      <button class="flash-toggle ${flashed.has(inv.id) ? 'done' : ''}" onclick="toggleFlash(event, '${inv.id}')">
        ${flashed.has(inv.id) ? '‚≠ê' : '‚òÜ'}
      </button>
    `;
    div.addEventListener('click', () => { focusInvader(inv.id); if (isMobile()) closeSidebar(); });
    list.appendChild(div);
  });
}

function planifierBalade() {
  if (!navigator.geolocation) { notify('G√©olocalisation non disponible', true); return; }
  notify('üìç Localisation en cours‚Ä¶');
  navigator.geolocation.getCurrentPosition(pos => {
    const origin = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    baladeOrigin = origin;
    const route = optimizeRoute(origin, allInvaders);
    baladeRoute = route;
    drawBalade(origin, route);
    renderBaladeList(origin, route);
    notify(`‚úÖ ${route.length} invaders trouv√©s autour de toi !`);
  }, () => {
    notify('Impossible de te localiser. Utilise "Depuis la carte".', true);
  });
}

function planifierBaladeDepuisCarte() {
  notify('Clique sur la carte pour choisir ton point de d√©part');
  map.once('click', e => {
    baladeOrigin = { lat: e.latlng.lat, lng: e.latlng.lng };
    const route = optimizeRoute(baladeOrigin, allInvaders);
    baladeRoute = route;
    drawBalade(baladeOrigin, route);
    renderBaladeList(baladeOrigin, route);
    notify(`‚úÖ ${route.length} invaders trouv√©s autour de ce point !`);
  });
}

function resetBalade() {
  clearBaladeMapElements();
  baladeRoute = [];
  baladeOrigin = null;
  document.getElementById('baladeList').innerHTML = '';
  document.getElementById('baladeSummary').classList.remove('visible');
  document.getElementById('baladeActions').style.display = 'none';
  stopNavigation();
}

// ===== NAVIGATION EN TEMPS R√âEL =====
function startNavigation() {
  if (baladeRoute.length === 0) return;
  navStep = 0;
  navActive = true;
  document.getElementById('navOverlay').classList.add('visible');
  updateNavStep();

  // GPS tracking
  if (navigator.geolocation) {
    watchId = navigator.geolocation.watchPosition(pos => {
      updatePosMarker(pos.coords.latitude, pos.coords.longitude);
      updateNavDistance(pos.coords.latitude, pos.coords.longitude);
    }, null, { enableHighAccuracy: true });
  }
}

function updateNavStep() {
  if (navStep >= baladeRoute.length) {
    stopNavigation();
    notify('üéâ Balade termin√©e ! Bien jou√© !');
    return;
  }
  const inv = baladeRoute[navStep];
  document.getElementById('navProgress').textContent = `√âtape ${navStep+1} / ${baladeRoute.length}`;
  document.getElementById('navId').textContent = inv.id;
  document.getElementById('navHint').textContent = inv.hint || '';

  // Highlight current step in list
  document.querySelectorAll('.balade-item').forEach((el, i) => {
    el.classList.toggle('current', i === navStep);
    el.classList.toggle('done-step', i < navStep);
    const num = el.querySelector('.step-num');
    if (num) {
      num.className = 'step-num' + (i === navStep ? ' current-num' : i < navStep ? ' done-num' : '');
      if (i < navStep) num.textContent = '‚úì';
    }
  });

  // Centre la carte sur l'invader cible
  map.setView([inv.lat, inv.lng], 17, { animate: true });
  if (markers[inv.id]) markers[inv.id].openPopup();

  // Scroll list to current step
  const currentItem = document.querySelector('.balade-item.current');
  if (currentItem) currentItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function updateNavDistance(userLat, userLng) {
  if (navStep >= baladeRoute.length) return;
  const inv = baladeRoute[navStep];
  const d = distanceM(userLat, userLng, inv.lat, inv.lng);
  document.getElementById('navDist').textContent = `üìç ${formatDist(d)} de l'invader`;
}

function updatePosMarker(lat, lng) {
  if (!posMarker) {
    const icon = L.divIcon({
      html: '<div class="pos-marker"></div>',
      className: '', iconSize: [16,16], iconAnchor: [8,8]
    });
    posMarker = L.marker([lat, lng], { icon, zIndexOffset: 1000 }).addTo(map);
  } else {
    posMarker.setLatLng([lat, lng]);
  }
}

function navFlash() {
  const inv = baladeRoute[navStep];
  flashed.add(inv.id);
  saveFlashed();
  renderAll();
  navStep++;
  updateNavStep();
}

function navSkip() {
  navStep++;
  updateNavStep();
}

function stopNavigation() {
  navActive = false;
  document.getElementById('navOverlay').classList.remove('visible');
  if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
}


// ===== MOBILE PANELS =====

let mobileSearchOpen = false;
let mobileBaladeOpen = false;
let mobileFilterCurrent = 'all';

function toggleMobileSearch() {
  mobileSearchOpen = !mobileSearchOpen;
  mobileBaladeOpen = false;
  document.getElementById('mobileSearchPanel').classList.toggle('open', mobileSearchOpen);
  document.getElementById('mobileBaladePanel').classList.remove('open');
  document.getElementById('fabSearch').classList.toggle('active', mobileSearchOpen);
  document.getElementById('fabBalade').classList.remove('active');
  if (mobileSearchOpen) document.getElementById('mobileSearchInput').focus();
}

function toggleMobileBalade() {
  mobileBaladeOpen = !mobileBaladeOpen;
  mobileSearchOpen = false;
  document.getElementById('mobileBaladePanel').classList.toggle('open', mobileBaladeOpen);
  document.getElementById('mobileSearchPanel').classList.remove('open');
  document.getElementById('fabBalade').classList.toggle('active', mobileBaladeOpen);
  document.getElementById('fabSearch').classList.remove('active');
}

function closeMobileBalade() {
  mobileBaladeOpen = false;
  document.getElementById('mobileBaladePanel').classList.remove('open');
  document.getElementById('fabBalade').classList.remove('active');
}

function centerOnPosition() {
  if (!navigator.geolocation) { notify('G√©olocalisation non disponible', true); return; }
  navigator.geolocation.getCurrentPosition(pos => {
    map.setView([pos.coords.latitude, pos.coords.longitude], 16, { animate: true });
    updatePosMarker(pos.coords.latitude, pos.coords.longitude);
  }, () => notify('Impossible de te localiser', true));
}

function setMobileFilter(f, btn) {
  mobileFilterCurrent = f;
  document.querySelectorAll('#mobileSearchPanel .toggle-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderMobileResults();
}

function renderMobileResults() {
  const term = document.getElementById('mobileSearchInput').value.toLowerCase();
  const list = document.getElementById('mobileResultList');
  if (!term && mobileFilterCurrent === 'all') { list.innerHTML = ''; return; }

  let results = allInvaders.filter(inv => inv.id.startsWith('PA_'));
  if (term) results = results.filter(inv => inv.id.toLowerCase().includes(term));
  if (mobileFilterCurrent === 'ok') results = results.filter(inv => inv.status === 'ok');
  else if (mobileFilterCurrent === 'damaged') results = results.filter(inv => inv.status === 'damaged');
  else if (mobileFilterCurrent === 'destroyed') results = results.filter(inv => inv.status === 'destroyed');
  else if (mobileFilterCurrent === 'notflashed') results = results.filter(inv => !flashed.has(inv.id));

  results = results.slice(0, 30);
  list.innerHTML = results.map(inv => `
    <div onclick="focusInvader('${inv.id}'); toggleMobileSearch();" style="
      padding:8px 4px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:8px; cursor:pointer;
    ">
      <span style="font-size:14px;">${statusEmoji(inv.status)}</span>
      <span style="font-family:'Space Mono',monospace; font-size:12px; color:var(--accent);">${inv.id}</span>
      ${inv.hint ? `<span style="font-size:10px; color:var(--muted); flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${inv.hint}</span>` : ''}
      ${flashed.has(inv.id) ? '<span style="font-size:12px;">‚≠ê</span>' : ''}
    </div>
  `).join('');
}

document.getElementById('mobileSearchInput').addEventListener('input', renderMobileResults);

// Mobile balade controls
function updateMobileRadius() {
  baladeRadius = parseInt(document.getElementById('mobileBaladeRadius').value);
  document.getElementById('mobileRadiusVal').textContent = baladeRadius + 'm';
  // Sync desktop slider
  const desk = document.getElementById('baladeRadius');
  if (desk) { desk.value = baladeRadius; document.getElementById('baladeRadiusVal').textContent = baladeRadius + 'm'; }
}
function updateMobileMax() {
  baladeMax = parseInt(document.getElementById('mobileBaladeMax').value);
  document.getElementById('mobileMaxVal').textContent = baladeMax;
  const desk = document.getElementById('baladeMax');
  if (desk) { desk.value = baladeMax; document.getElementById('baladeMaxVal').textContent = baladeMax; }
}

function renderMobileBaladeList(origin, route) {
  const list = document.getElementById('mobileBaladeList');
  const summary = document.getElementById('mobileBaladeSummary');
  const actions = document.getElementById('mobileBaladeActions');

  if (route.length === 0) {
    list.innerHTML = `<div style="padding:16px; text-align:center; color:var(--muted); font-size:12px; font-family:'Space Mono',monospace;">
      Aucun invader non flash√© dans ce rayon.<br>Essaie d'augmenter le rayon !
    </div>`;
    summary.style.display = 'none';
    actions.style.display = 'none';
    return;
  }

  const dist = totalDistance(origin, route);
  const walkMin = Math.round(dist / 80);
  summary.textContent = `${route.length} invaders ¬∑ ${formatDist(dist)} ¬∑ ~${walkMin} min`;
  summary.style.display = 'block';
  actions.style.display = 'block';

  list.innerHTML = route.map((inv, i) => `
    <div onclick="focusInvader('${inv.id}')" style="
      display:flex; align-items:center; gap:8px;
      padding:9px 14px; border-bottom:1px solid rgba(30,30,46,0.5); cursor:pointer;
    ">
      <div style="
        width:22px; height:22px; border-radius:50%;
        background:#ffcc00; color:#000;
        display:flex; align-items:center; justify-content:center;
        font-family:'Space Mono',monospace; font-size:10px; font-weight:700;
        flex-shrink:0;
      ">${i+1}</div>
      <div style="flex:1; min-width:0;">
        <div style="font-family:'Space Mono',monospace; font-size:12px; font-weight:700; color:var(--accent);">${inv.id}</div>
        <div style="font-size:10px; color:var(--muted);">${formatDist(inv._dist || 0)}${inv.hint ? ' ¬∑ ' + inv.hint : ''}</div>
      </div>
      <button onclick="event.stopPropagation(); toggleFlash(event, '${inv.id}')" style="
        background:none; border:1px solid var(--border); border-radius:50%;
        width:26px; height:26px; cursor:pointer; font-size:13px;
        display:flex; align-items:center; justify-content:center;
      ">${flashed.has(inv.id) ? '‚≠ê' : '‚òÜ'}</button>
    </div>
  `).join('');
}

function mobilePlanifierPosition() {
  if (!navigator.geolocation) { notify('G√©olocalisation non disponible', true); return; }
  notify('üìç Localisation en cours‚Ä¶');
  navigator.geolocation.getCurrentPosition(pos => {
    const origin = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    baladeOrigin = origin;
    const route = optimizeRoute(origin, allInvaders);
    baladeRoute = route;
    drawBalade(origin, route);
    renderBaladeList(origin, route);       // desktop
    renderMobileBaladeList(origin, route); // mobile
    notify(`‚úÖ ${route.length} invaders trouv√©s !`);
  }, () => notify('Impossible de te localiser', true));
}

function mobilePlanifierCarte() {
  closeMobileBalade();
  notify('Clique sur la carte pour choisir ton point de d√©part');
  map.once('click', e => {
    const origin = { lat: e.latlng.lat, lng: e.latlng.lng };
    baladeOrigin = origin;
    const route = optimizeRoute(origin, allInvaders);
    baladeRoute = route;
    drawBalade(origin, route);
    renderBaladeList(origin, route);
    renderMobileBaladeList(origin, route);
    toggleMobileBalade();
    notify(`‚úÖ ${route.length} invaders trouv√©s !`);
  });
}

// Fermer les panneaux mobiles si on clique sur la carte
document.getElementById('map').addEventListener('click', () => {
  if (mobileSearchOpen) toggleMobileSearch();
});

// ===== MOBILE =====
function isMobile() { return window.innerWidth <= 768; }

function openSidebar() {
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('sidebarBackdrop').classList.add('visible');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarBackdrop').classList.remove('visible');
  document.querySelectorAll('.bottom-nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('bnMap').classList.add('active');
}
function bottomNav(tab) {
  document.querySelectorAll('.bottom-nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('bn' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  if (tab === 'map') { closeSidebar(); return; }
  openSidebar();
  const tabs = document.querySelectorAll('.mode-tab');
  if (tab === 'balade') {
    switchTab('balade', tabs[1]);
  } else {
    switchTab('liste', tabs[0]);
    if (tab === 'flash') {
      const btn = document.querySelector('[data-filter="notflashed"]');
      if (btn) setFilter('notflashed', btn);
    } else if (tab === 'search') {
      setTimeout(() => document.getElementById('searchInput')?.focus(), 400);
    }
  }
}

// ===== START =====
init();
</script>
</body>
</html>