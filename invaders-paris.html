<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üëæ Invaders Paris</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root {
    --bg: #0a0a0f;
    --panel: #111118;
    --border: #1e1e2e;
    --accent: #00ff88;
    --accent2: #ff3366;
    --accent3: #ffcc00;
    --text: #e0e0f0;
    --muted: #555570;
    --flashed: #2a2a3a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Syne', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* HEADER */
  header {
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    padding: 10px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
    z-index: 1000;
  }
  .logo {
    font-size: 22px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: var(--accent);
    text-shadow: 0 0 20px rgba(0,255,136,0.4);
  }
  .logo span { color: var(--accent2); }

  .stats-bar {
    display: flex;
    gap: 20px;
    margin-left: auto;
    font-family: 'Space Mono', monospace;
    font-size: 12px;
  }
  .stat {
    text-align: center;
  }
  .stat-value {
    color: var(--accent);
    font-size: 16px;
    font-weight: 700;
    display: block;
  }
  .stat-value.red { color: var(--accent2); }
  .stat-value.yellow { color: var(--accent3); }
  .stat-label {
    color: var(--muted);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* MAIN LAYOUT */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* SIDEBAR */
  .sidebar {
    width: 320px;
    background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow: hidden;
  }

  .sidebar-controls {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .search-box {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 12px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    width: 100%;
    outline: none;
    transition: border-color 0.2s;
  }
  .search-box:focus { border-color: var(--accent); }
  .search-box::placeholder { color: var(--muted); }

  .filter-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .toggle-btn {
    padding: 5px 10px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .toggle-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); font-weight: 700; }
  .toggle-btn.red.active { background: var(--accent2); border-color: var(--accent2); }
  .toggle-btn.yellow.active { background: var(--accent3); border-color: var(--accent3); color: #000; }

  .uid-row {
    display: flex;
    gap: 6px;
  }
  .uid-input {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 7px 10px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    outline: none;
  }
  .uid-input:focus { border-color: var(--accent3); }
  .uid-input::placeholder { color: var(--muted); font-size: 10px; }

  .btn {
    padding: 7px 12px;
    border-radius: 6px;
    border: none;
    background: var(--accent);
    color: var(--bg);
    font-family: 'Syne', sans-serif;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn:hover { filter: brightness(1.2); }
  .btn.danger { background: var(--accent2); }
  .btn.yellow { background: var(--accent3); color: #000; }
  .btn.gray { background: var(--border); color: var(--text); }

  .section-title {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--muted);
    padding: 10px 16px 6px;
    border-bottom: 1px solid var(--border);
  }

  /* LIST */
  .invader-list {
    flex: 1;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .invader-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    border-bottom: 1px solid rgba(30,30,46,0.5);
    cursor: pointer;
    transition: background 0.15s;
  }
  .invader-item:hover { background: rgba(0,255,136,0.04); }
  .invader-item.flashed { opacity: 0.4; background: var(--flashed); }
  .invader-item.active { background: rgba(0,255,136,0.08); border-left: 2px solid var(--accent); }

  .item-thumb {
    width: 36px;
    height: 36px;
    border-radius: 4px;
    object-fit: cover;
    background: var(--border);
    flex-shrink: 0;
    border: 1px solid var(--border);
  }
  .item-thumb-placeholder {
    width: 36px;
    height: 36px;
    border-radius: 4px;
    background: var(--border);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .item-info { flex: 1; min-width: 0; }
  .item-id {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    font-weight: 700;
    color: var(--accent);
  }
  .item-id.destroyed { color: var(--accent2); }
  .item-status {
    font-size: 10px;
    color: var(--muted);
    margin-top: 1px;
  }

  .flash-toggle {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 1.5px solid var(--border);
    background: transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .flash-toggle:hover { border-color: var(--accent3); }
  .flash-toggle.done { background: rgba(255,204,0,0.15); border-color: var(--accent3); }

  /* MAP */
  #map {
    flex: 1;
    z-index: 1;
  }

  /* POPUP */
  .popup-card {
    font-family: 'Syne', sans-serif;
    min-width: 200px;
    max-width: 260px;
  }
  .popup-img {
    width: 100%;
    height: 140px;
    object-fit: cover;
    border-radius: 6px;
    margin-bottom: 10px;
    background: #222;
  }
  .popup-id {
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    font-size: 15px;
    color: #00ff88;
    margin-bottom: 4px;
  }
  .popup-status {
    font-size: 11px;
    color: #888;
    margin-bottom: 10px;
  }
  .popup-flash-btn {
    width: 100%;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ffcc00;
    background: rgba(255,204,0,0.1);
    color: #ffcc00;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }
  .popup-flash-btn:hover { background: rgba(255,204,0,0.25); }
  .popup-flash-btn.flashed { background: rgba(255,204,0,0.2); border-color: rgba(255,204,0,0.4); }

  /* NOTIFICATION */
  .notif {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--panel);
    border: 1px solid var(--accent);
    border-radius: 8px;
    padding: 12px 18px;
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    color: var(--accent);
    z-index: 9999;
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s;
    max-width: 300px;
  }
  .notif.show { transform: translateY(0); opacity: 1; }
  .notif.error { border-color: var(--accent2); color: var(--accent2); }

  /* LOADING */
  .loading-overlay {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 20px;
  }
  .loading-title {
    font-size: 32px;
    font-weight: 800;
    color: var(--accent);
    text-shadow: 0 0 30px rgba(0,255,136,0.5);
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }
  .loading-sub {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    color: var(--muted);
    text-align: center;
    line-height: 1.8;
  }
  .progress-bar {
    width: 280px;
    height: 2px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: var(--accent);
    width: 0%;
    transition: width 0.3s;
    box-shadow: 0 0 8px var(--accent);
  }

  /* INSTAGRAM PANEL */
  .ig-panel {
    position: fixed;
    right: 0;
    top: 0;
    bottom: 0;
    width: 380px;
    background: var(--panel);
    border-left: 1px solid var(--border);
    z-index: 2000;
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: -8px 0 30px rgba(0,0,0,0.5);
  }
  .ig-panel.open { transform: translateX(0); }

  .ig-panel-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
  }
  .ig-panel-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    flex: 1;
  }
  .ig-panel-id {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--accent);
  }
  .ig-close {
    background: none;
    border: none;
    color: var(--muted);
    font-size: 18px;
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    transition: color 0.2s;
  }
  .ig-close:hover { color: var(--text); }

  .ig-frame-wrap {
    flex: 1;
    overflow: hidden;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .ig-frame-wrap iframe {
    width: 100%;
    height: 100%;
    border: none;
  }
  .ig-open-btn {
    padding: 14px 16px;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }
  .ig-open-btn a {
    display: block;
    text-align: center;
    padding: 10px;
    border-radius: 6px;
    background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045);
    color: #fff;
    font-weight: 700;
    font-size: 13px;
    text-decoration: none;
    transition: opacity 0.2s;
  }
  .ig-open-btn a:hover { opacity: 0.85; }

  /* IMPORT SECTION */
  .import-section {
    padding: 12px 16px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 6px;
    flex-direction: column;
  }
  .import-label {
    font-size: 10px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .import-row { display: flex; gap: 6px; }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* Leaflet overrides */
  .leaflet-popup-content-wrapper {
    background: #111118 !important;
    border: 1px solid #1e1e2e !important;
    border-radius: 10px !important;
    box-shadow: 0 8px 30px rgba(0,0,0,0.6) !important;
  }
  .leaflet-popup-tip { background: #111118 !important; }
  .leaflet-popup-content { margin: 14px !important; }

  /* Custom markers */
  .marker-ok { 
    background: rgba(0,255,136,0.9);
    border: 2px solid rgba(0,255,136,1);
  }
  .marker-destroyed {
    background: rgba(255,51,102,0.9);
    border: 2px solid rgba(255,51,102,1);
  }
  .marker-damaged {
    background: rgba(255,204,0,0.9);
    border: 2px solid rgba(255,204,0,1);
  }
  .marker-flashed {
    opacity: 0.3;
  }

  .hidden-row { display: none; }
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-title">üëæ INVADERS PARIS</div>
  <div class="loading-sub" id="loadingMsg">Connexion √† pnote.eu‚Ä¶</div>
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
</div>

<!-- HEADER -->
<header>
  <div class="logo">üëæ INVADERS <span>PARIS</span></div>
  <div class="stats-bar">
    <div class="stat">
      <span class="stat-value" id="statTotal">0</span>
      <span class="stat-label">Total</span>
    </div>
    <div class="stat">
      <span class="stat-value yellow" id="statFlashed">0</span>
      <span class="stat-label">Flash√©s</span>
    </div>
    <div class="stat">
      <span class="stat-value" id="statRemaining">0</span>
      <span class="stat-label">Restants</span>
    </div>
    <div class="stat">
      <span class="stat-value red" id="statDestroyed">0</span>
      <span class="stat-label">D√©truits</span>
    </div>
  </div>
</header>

<div class="main">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-controls">
      <input type="text" class="search-box" id="searchInput" placeholder="üîç Chercher un ID (PA_xxx)‚Ä¶">
      <div class="filter-row">
        <button class="toggle-btn active" data-filter="all" onclick="setFilter('all', this)">Tous</button>
        <button class="toggle-btn" data-filter="ok" onclick="setFilter('ok', this)">‚úÖ OK</button>
        <button class="toggle-btn yellow" data-filter="damaged" onclick="setFilter('damaged', this)">‚ö†Ô∏è Endommag√©</button>
        <button class="toggle-btn red" data-filter="destroyed" onclick="setFilter('destroyed', this)">üíÄ D√©truit</button>
        <button class="toggle-btn" data-filter="notflashed" onclick="setFilter('notflashed', this)">üéØ Non flash√©s</button>
      </div>
      <div class="uid-row">
        <input type="text" class="uid-input" id="uidInput" placeholder="Ton UID Flash Invaders (optionnel)">
        <button class="btn yellow" onclick="loadFromUID()">Sync</button>
      </div>
    </div>
    <div class="section-title" id="listCount">LISTE ‚Äî 0 invaders</div>
    <div class="invader-list" id="invaderList"></div>
    <div class="import-section">
      <span class="import-label">Sauvegarde locale</span>
      <div class="import-row">
        <button class="btn gray" style="flex:1" onclick="exportFlashed()">‚¨á Export</button>
        <label class="btn gray" style="flex:1; text-align:center; cursor:pointer">
          ‚¨Ü Import
          <input type="file" accept=".json" style="display:none" onchange="importFlashed(event)">
        </label>
        <button class="btn danger" onclick="resetFlashed()">Reset</button>
      </div>
    </div>
  </div>

  <!-- MAP -->
  <div id="map"></div>
</div>

<!-- INSTAGRAM PANEL -->
<div class="ig-panel" id="igPanel">
  <div class="ig-panel-header">
    <div style="font-size:20px">üì∏</div>
    <div>
      <div class="ig-panel-title">Photos Instagram</div>
      <div class="ig-panel-id" id="igPanelId"></div>
    </div>
    <button class="ig-close" onclick="closeIgPanel()">‚úï</button>
  </div>
  <div class="ig-frame-wrap" id="igFrameWrap">
    <div style="color:#555; font-size:13px; text-align:center; padding:20px; font-family:'Space Mono',monospace;">
      S√©lectionne un invader<br>pour voir les photos
    </div>
  </div>
  <div class="ig-open-btn">
    <a id="igOpenLink" href="#" target="_blank">‚Üó Ouvrir sur Instagram</a>
  </div>
</div>

<!-- NOTIFICATION -->
<div class="notif" id="notif"></div>

<script>
// ===== STATE =====
let imageMap = {}; // PA_xxx ‚Üí URL photo
let allInvaders = [];
let flashed = new Set(JSON.parse(localStorage.getItem('flashedInvaders') || '[]'));
let currentFilter = 'all';
let searchTerm = '';
let map, markers = {};
let activeItem = null;

// ===== INIT =====
async function init() {
  await initMap();
  await loadData();
}

async function initMap() {
  map = L.map('map', { center: [48.8566, 2.3522], zoom: 14 });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    className: 'grayscale-tiles'
  }).addTo(map);

  // Apply dark/grayscale filter to tiles
  const style = document.createElement('style');
  style.textContent = `.grayscale-tiles { filter: invert(1) hue-rotate(180deg) brightness(0.7) contrast(0.9) saturate(0.3); }`;
  document.head.appendChild(style);
}

// ===== DATA LOADING =====
function showLocalFileInstructions() {
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed; inset: 0; background: rgba(10,10,15,0.92);
    z-index: 9998; display: flex; align-items: center; justify-content: center;
  `;
  overlay.innerHTML = `
    <div style="
      background: #111118; border: 1px solid #ffcc00; border-radius: 12px;
      padding: 32px; max-width: 480px; font-family: 'Syne', sans-serif; color: #e0e0f0;
    ">
      <div style="font-size:24px; font-weight:800; color:#ffcc00; margin-bottom:12px;">
        ‚ö†Ô∏è Fichier de donn√©es manquant
      </div>
      <p style="font-size:14px; line-height:1.7; color:#aaa; margin-bottom:20px;">
        Pour afficher les 1600+ invaders de Paris, tu dois placer le fichier 
        <code style="background:#1e1e2e; padding:2px 6px; border-radius:4px; color:#00ff88;">invaders.json</code>
        dans le <strong style="color:#fff">m√™me dossier</strong> que cette application.
      </p>
      <div style="background:#0a0a0f; border-radius:8px; padding:16px; margin-bottom:20px; font-size:13px; line-height:2;">
        <strong style="color:#00ff88;">√âtape 1</strong> ‚Äî Ouvre ce lien dans Chrome et fais <kbd style="background:#1e1e2e; padding:2px 6px; border-radius:3px;">Cmd+S</kbd> :<br>
        <a href="https://pnote.eu/projects/invaders/map/invaders.json?nocache=1" target="_blank"
           style="color:#ffcc00; word-break:break-all; font-size:11px;">
          https://pnote.eu/projects/invaders/map/invaders.json
        </a><br><br>
        <strong style="color:#00ff88;">√âtape 2</strong> ‚Äî Renomme le fichier en <code style="background:#1e1e2e; padding:2px 6px; border-radius:4px; color:#fff;">invaders.json</code><br><br>
        <strong style="color:#00ff88;">√âtape 3</strong> ‚Äî Mets-le dans le m√™me dossier que <code style="background:#1e1e2e; padding:2px 6px; border-radius:4px; color:#fff;">invaders-paris.html</code><br><br>
        <strong style="color:#00ff88;">√âtape 4</strong> ‚Äî Recharge la page (<kbd style="background:#1e1e2e; padding:2px 6px; border-radius:3px;">Cmd+R</kbd>)
      </div>
      <div style="display:flex; gap:10px;">
        <button onclick="this.closest('div[style]').parentElement.remove()" style="
          flex:1; padding:10px; border-radius:6px; border:none;
          background:#1e1e2e; color:#aaa; font-family:'Syne',sans-serif;
          font-size:13px; cursor:pointer;
        ">Continuer avec la d√©mo (29 invaders)</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
}
async function loadData() {
  setProgress(10, 'Chargement du fichier local invaders.json‚Ä¶');
  // Load images.json if available
  try {
    const r = await fetch('./images.json');
    if (r.ok) { imageMap = await r.json(); console.log(`üì∏ ${Object.keys(imageMap).length} photos charg√©es`); }
  } catch(e) {}

  // Strategy 1: local file in same folder (best ‚Äî no CORS)
  let data = await tryLoadLocal();

  if (!data || data.length === 0) {
    setProgress(30, 'Fichier local non trouv√© ‚Äî tentative pnote.eu‚Ä¶');
    data = await tryLoadPnote();
  }

  if (!data || data.length === 0) {
    setProgress(60, 'pnote.eu bloqu√©. Donn√©es de d√©mo (29 invaders)‚Ä¶');
    data = getDemoData();
    showLocalFileInstructions();
  }

  setProgress(80, `${data.length} invaders charg√©s ‚Äî rendu de la carte‚Ä¶`);
  allInvaders = data;

  await renderAll();
  setProgress(100, 'Pr√™t !');

  setTimeout(() => {
    document.getElementById('loadingOverlay').style.display = 'none';
  }, 400);
}

async function tryLoadLocal() {
  // Tries to load invaders.json from the same folder as this HTML file
  try {
    const r = await fetch('./invaders.json', { signal: AbortSignal.timeout(5000) });
    if (r.ok) {
      const json = await r.json();
      const parsed = parsePnoteData(json);
      if (parsed.length > 0) {
        setProgress(70, `‚úÖ ${parsed.length} invaders charg√©s depuis le fichier local !`);
        return parsed;
      }
    }
  } catch(e) { /* file not present */ }
  return null;
}

async function tryLoadPnote() {
  const url = `https://pnote.eu/projects/invaders/map/invaders.json?nocache=${Date.now()}`;
  try {
    const r = await fetch(url, { mode: 'cors', signal: AbortSignal.timeout(10000) });
    if (r.ok) {
      const json = await r.json();
      const parsed = parsePnoteData(json);
      if (parsed.length > 0) return parsed;
    }
  } catch(e) { /* CORS blocked */ }
  return null;
}

async function tryLoadInvaderSpotter() {
  try {
    const r = await fetch('https://www.invader-spotter.art/api/invaders?city=paris&limit=2000', {
      mode: 'cors', signal: AbortSignal.timeout(5000)
    });
    if (r.ok) {
      const json = await r.json();
      return parseInvaderSpotterData(json);
    }
  } catch(e) {}
  return null;
}

function parsePnoteData(json) {
  if (!Array.isArray(json)) return [];
  // Garde uniquement Paris (IDs commencent par PA_)
  return json
    .filter(d => d.id && d.id.startsWith('PA_') && d.obf_lat && d.obf_lng)
    .map(d => ({
      id: d.id,
      lat: d.obf_lat,
      lng: d.obf_lng,
      status: (d.status || 'OK').toLowerCase(),
      hint: d.hint || null,
      instagramUrl: d.instagramUrl || null,
      img: getImgUrl(d.id),
      city: 'Paris'
    }));
}

function parseInvaderSpotterData(json) {
  if (!json || !json.data) return [];
  return json.data.map(d => ({
    id: d.reference || d.id,
    lat: parseFloat(d.lat),
    lng: parseFloat(d.lng),
    status: d.status || 'ok',
    points: d.points || 10,
    img: d.image || getImgUrl(d.reference),
    city: 'Paris'
  })).filter(d => d.lat && d.lng);
}

function getImgUrl(id) {
  if (!id) return null;
  // Use imageMap if loaded from images.json
  if (imageMap && imageMap[id]) return imageMap[id];
  return null;
}

// Demo data ‚Äî a sample of real Paris invaders with approximate coords
function getDemoData() {
  const parisInvaders = [
    { id: 'PA_001', lat: 48.8551, lng: 2.3507, status: 'ok', points: 10 },
    { id: 'PA_002', lat: 48.8548, lng: 2.3493, status: 'ok', points: 10 },
    { id: 'PA_010', lat: 48.8538, lng: 2.3489, status: 'ok', points: 10 },
    { id: 'PA_020', lat: 48.8603, lng: 2.3528, status: 'ok', points: 20 },
    { id: 'PA_030', lat: 48.8520, lng: 2.3415, status: 'ok', points: 10 },
    { id: 'PA_050', lat: 48.8612, lng: 2.3499, status: 'destroyed', points: 10 },
    { id: 'PA_075', lat: 48.8567, lng: 2.3587, status: 'ok', points: 20 },
    { id: 'PA_100', lat: 48.8580, lng: 2.3610, status: 'ok', points: 30 },
    { id: 'PA_150', lat: 48.8490, lng: 2.3580, status: 'damaged', points: 10 },
    { id: 'PA_200', lat: 48.8650, lng: 2.3460, status: 'ok', points: 20 },
    { id: 'PA_250', lat: 48.8715, lng: 2.3350, status: 'ok', points: 10 },
    { id: 'PA_300', lat: 48.8430, lng: 2.3650, status: 'ok', points: 20 },
    { id: 'PA_350', lat: 48.8785, lng: 2.3290, status: 'destroyed', points: 10 },
    { id: 'PA_400', lat: 48.8710, lng: 2.3680, status: 'ok', points: 30 },
    { id: 'PA_450', lat: 48.8395, lng: 2.3785, status: 'ok', points: 20 },
    { id: 'PA_500', lat: 48.8480, lng: 2.3210, status: 'damaged', points: 10 },
    { id: 'PA_550', lat: 48.8830, lng: 2.3490, status: 'ok', points: 20 },
    { id: 'PA_600', lat: 48.8325, lng: 2.3680, status: 'ok', points: 30 },
    { id: 'PA_700', lat: 48.8620, lng: 2.3820, status: 'ok', points: 10 },
    { id: 'PA_800', lat: 48.8750, lng: 2.3750, status: 'ok', points: 20 },
    { id: 'PA_900', lat: 48.8290, lng: 2.3540, status: 'ok', points: 20 },
    { id: 'PA_1000', lat: 48.8680, lng: 2.3090, status: 'ok', points: 50 },
    { id: 'PA_1100', lat: 48.8570, lng: 2.4050, status: 'ok', points: 10 },
    { id: 'PA_1200', lat: 48.8950, lng: 2.3690, status: 'destroyed', points: 20 },
    { id: 'PA_1300', lat: 48.8190, lng: 2.3490, status: 'ok', points: 10 },
    { id: 'PA_1400', lat: 48.8640, lng: 2.3190, status: 'ok', points: 10 },
    { id: 'PA_1431', lat: 48.8584, lng: 2.2945, status: 'ok', points: 100 }, // Tour Eiffel
    { id: 'PA_1500', lat: 48.8710, lng: 2.4150, status: 'ok', points: 20 },
    { id: 'PA_1529', lat: 48.8555, lng: 2.3460, status: 'ok', points: 30 },
  ];

  return parisInvaders.map(d => ({
    ...d,
    img: getImgUrl(d.id),
    city: 'Paris'
  }));
}

// ===== RENDER =====
async function renderAll() {
  renderList();
  renderMarkers();
  updateStats();
}

function renderList() {
  const list = document.getElementById('invaderList');
  const filtered = getFiltered();
  document.getElementById('listCount').textContent = `LISTE ‚Äî ${filtered.length} invaders`;

  list.innerHTML = '';
  filtered.forEach(inv => {
    const isFlashed = flashed.has(inv.id);
    const div = document.createElement('div');
    div.className = `invader-item ${isFlashed ? 'flashed' : ''}`;
    div.dataset.id = inv.id;
    div.innerHTML = `
      <div class="item-thumb-placeholder" title="${inv.id}">
        ${statusEmoji(inv.status)}
      </div>
      <div class="item-info">
        <div class="item-id ${inv.status === 'destroyed' ? 'destroyed' : ''}">${inv.id}</div>
        <div class="item-status">${statusLabel(inv.status)}${inv.points ? ` ‚Ä¢ ${inv.points}pts` : ''}</div>
      </div>
      <button class="flash-toggle ${isFlashed ? 'done' : ''}" onclick="toggleFlash(event, '${inv.id}')" title="Marquer comme flash√©">
        ${isFlashed ? '‚≠ê' : '‚òÜ'}
      </button>
    `;
    div.addEventListener('click', () => focusInvader(inv.id));
    list.appendChild(div);
  });
}

function renderMarkers() {
  // Clear existing
  Object.values(markers).forEach(m => m.remove());
  markers = {};

  const filtered = getFiltered();
  filtered.forEach(inv => {
    const isFlashed = flashed.has(inv.id);
    const color = isFlashed ? '#444466' :
      inv.status === 'destroyed' ? '#ff3366' :
      inv.status === 'damaged' ? '#ffcc00' : '#00ff88';

    const size = 12;
    const icon = L.divIcon({
      html: `<div style="
        width:${size}px; height:${size}px; 
        border-radius: 50%;
        background: ${color};
        border: 2px solid ${color};
        box-shadow: 0 0 ${isFlashed ? 0 : 8}px ${color};
        opacity: ${isFlashed ? 0.4 : 1};
        transition: all 0.2s;
      "></div>`,
      className: '',
      iconSize: [size, size],
      iconAnchor: [size/2, size/2]
    });

    const marker = L.marker([inv.lat, inv.lng], { icon })
      .addTo(map);

    marker.on('click', () => {
      showPopup(inv, marker);
    });

    markers[inv.id] = marker;
  });
}

function showPopup(inv, marker) {
  const isFlashed = flashed.has(inv.id);

  const popupContent = `
    <div class="popup-card">
      <img class="popup-img" 
        src="${inv.img}" 
        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
        alt="${inv.id}"
      />
      <div style="display:none; width:100%; height:80px; background:#1e1e2e; border-radius:6px; margin-bottom:10px; align-items:center; justify-content:center; font-size:32px;">üëæ</div>
      <div class="popup-id">${inv.id}</div>
      <div class="popup-status">${statusLabel(inv.status)}</div>
      ${inv.hint ? `<div style="font-size:11px;color:#aaa;margin-bottom:8px;font-style:italic;">${inv.hint}</div>` : ''}
      ${inv.instagramUrl ? `<button onclick="openIgPanel('${inv.id}', '${inv.instagramUrl}')" style="
        width:100%; padding:8px; border-radius:6px; border:1px solid #444;
        background: rgba(131,58,180,0.15); color:#cc88ff;
        font-family:'Syne',sans-serif; font-weight:700; font-size:12px;
        cursor:pointer; margin-bottom:8px; transition:all 0.2s;
        text-align:center;
      " onmouseover="this.style.background='rgba(131,58,180,0.3)'" 
         onmouseout="this.style.background='rgba(131,58,180,0.15)'">
        üì∏ Voir les photos
      </button>` : ''}
      <button class="popup-flash-btn ${isFlashed ? 'flashed' : ''}" onclick="toggleFlash(event, '${inv.id}')">
        ${isFlashed ? '‚≠ê Flash√© !' : '‚òÜ Marquer comme flash√©'}
      </button>
    </div>
  `;

  marker.bindPopup(popupContent, { maxWidth: 280 }).openPopup();

  // Highlight list item
  document.querySelectorAll('.invader-item').forEach(el => el.classList.remove('active'));
  const listItem = document.querySelector(`.invader-item[data-id="${inv.id}"]`);
  if (listItem) {
    listItem.classList.add('active');
    listItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
  activeItem = inv.id;
}

function focusInvader(id) {
  const inv = allInvaders.find(i => i.id === id);
  if (!inv) return;
  map.setView([inv.lat, inv.lng], 17, { animate: true });
  if (markers[id]) {
    showPopup(inv, markers[id]);
  }
}

// ===== FILTERING =====
function getFiltered() {
  let list = allInvaders.filter(inv => inv.city === 'Paris' || inv.city === 'paris' || !inv.city);
  
  if (searchTerm) {
    list = list.filter(inv => inv.id.toLowerCase().includes(searchTerm));
  }

  if (currentFilter === 'ok') list = list.filter(inv => inv.status === 'ok');
  else if (currentFilter === 'damaged') list = list.filter(inv => inv.status === 'damaged');
  else if (currentFilter === 'destroyed') list = list.filter(inv => inv.status === 'destroyed');
  else if (currentFilter === 'notflashed') list = list.filter(inv => !flashed.has(inv.id));

  return list;
}

function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderAll();
}

document.getElementById('searchInput').addEventListener('input', e => {
  searchTerm = e.target.value.toLowerCase();
  renderAll();
});

// ===== FLASH TOGGLE =====
function toggleFlash(event, id) {
  event.stopPropagation();
  if (flashed.has(id)) {
    flashed.delete(id);
    notify(`${id} ‚Äî non flash√©`);
  } else {
    flashed.add(id);
    notify(`‚≠ê ${id} ‚Äî flash√© !`);
  }
  saveFlashed();
  renderAll();

  // Refresh popup if open
  const inv = allInvaders.find(i => i.id === id);
  if (inv && markers[id] && markers[id].isPopupOpen()) {
    markers[id].closePopup();
    setTimeout(() => showPopup(inv, markers[id]), 50);
  }
}

function saveFlashed() {
  localStorage.setItem('flashedInvaders', JSON.stringify([...flashed]));
  updateStats();
}

// ===== STATS =====
function updateStats() {
  const paris = allInvaders.filter(i => i.city === 'Paris' || i.city === 'paris' || !i.city);
  const total = paris.length;
  const numFlashed = paris.filter(i => flashed.has(i.id)).length;
  const destroyed = paris.filter(i => i.status === 'destroyed').length;

  document.getElementById('statTotal').textContent = total;
  document.getElementById('statFlashed').textContent = numFlashed;
  document.getElementById('statRemaining').textContent = total - numFlashed - destroyed;
  document.getElementById('statDestroyed').textContent = destroyed;
}

// ===== UID IMPORT =====
async function loadFromUID() {
  const uid = document.getElementById('uidInput').value.trim();
  if (!uid) { notify('Entre ton UID Flash Invaders', true); return; }

  notify('Synchronisation en cours‚Ä¶');
  try {
    // Flash Invaders API ‚Äî discovered by the community
    const r = await fetch(`https://api.space-invaders.com/user/${uid}/flashes`, {
      mode: 'cors', signal: AbortSignal.timeout(8000)
    });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();

    const ids = data.map ? data.map(f => f.invader_id || f.id || f.reference).filter(Boolean) : [];
    if (ids.length === 0) throw new Error('Aucun flash trouv√©');

    ids.forEach(id => flashed.add(id));
    saveFlashed();
    renderAll();
    notify(`‚úÖ ${ids.length} flashs import√©s depuis ton compte !`);
  } catch(e) {
    // Try alternate endpoint pattern
    try {
      const r2 = await fetch(`https://api.flash-invaders.com/user/flashes?uid=${uid}`, {
        mode: 'cors', signal: AbortSignal.timeout(5000)
      });
      if (r2.ok) {
        const d = await r2.json();
        notify(`‚úÖ Import√© depuis Flash Invaders`);
        return;
      }
    } catch(e2) {}
    notify(`L'API Flash Invaders est inaccessible directement.\nUtilise le script Python ci-dessous pour r√©cup√©rer tes flashs.`, true);
  }
}

// ===== EXPORT / IMPORT =====
function exportFlashed() {
  const data = { flashedInvaders: [...flashed], exportDate: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `invaders-paris-${Date.now()}.json`;
  a.click();
  notify('‚úÖ Export t√©l√©charg√©');
}

function importFlashed(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      const ids = data.flashedInvaders || data;
      if (Array.isArray(ids)) {
        ids.forEach(id => flashed.add(id));
        saveFlashed();
        renderAll();
        notify(`‚úÖ ${ids.length} flashs import√©s`);
      }
    } catch(err) { notify('Fichier JSON invalide', true); }
  };
  reader.readAsText(file);
}

function resetFlashed() {
  if (!confirm('R√©initialiser tous les flashs ?')) return;
  flashed.clear();
  saveFlashed();
  renderAll();
  notify('Flashs r√©initialis√©s');
}

// ===== UTILS =====
function statusEmoji(s) {
  if (s === 'destroyed') return 'üíÄ';
  if (s === 'damaged') return '‚ö†Ô∏è';
  return 'üëæ';
}
function statusLabel(s) {
  if (s === 'destroyed') return 'üíÄ D√©truit';
  if (s === 'damaged') return '‚ö†Ô∏è Endommag√©';
  return '‚úÖ OK';
}

function setProgress(pct, msg) {
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('loadingMsg').textContent = msg;
}

let notifTimer;
function notify(msg, isError = false) {
  const el = document.getElementById('notif');
  el.textContent = msg;
  el.className = 'notif show' + (isError ? ' error' : '');
  clearTimeout(notifTimer);
  notifTimer = setTimeout(() => el.className = 'notif', 3500);
}

// ===== INSTAGRAM PANEL =====
function openIgPanel(id, igUrl) {
  const panel = document.getElementById('igPanel');
  const frameWrap = document.getElementById('igFrameWrap');
  const openLink = document.getElementById('igOpenLink');

  document.getElementById('igPanelId').textContent = id;
  openLink.href = igUrl;

  // Show tag page embedded ‚Äî Instagram allows tag pages in iframes on some browsers
  // We use a tag search URL which is more likely to work
  const tag = id.toLowerCase().replace('_', '_');
  frameWrap.innerHTML = `
    <div style="
      display:flex; flex-direction:column; align-items:center; 
      justify-content:center; gap:16px; padding:30px; text-align:center;
    ">
      <div style="font-size:48px;">üì∏</div>
      <div style="font-family:'Space Mono',monospace; font-size:13px; color:#00ff88;">${id}</div>
      <div style="font-size:12px; color:#888; line-height:1.8;">
        Instagram bloque l'affichage direct.<br>
        Clique sur le bouton ci-dessous<br>pour voir les photos dans un nouvel onglet.
      </div>
      <a href="${igUrl}" target="_blank" style="
        padding:12px 20px; border-radius:8px;
        background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045);
        color:#fff; font-weight:700; font-size:13px; text-decoration:none;
        font-family:'Syne',sans-serif;
      ">Voir #${id.toLowerCase()} sur Instagram ‚Üó</a>
      <div style="font-size:10px; color:#444; font-family:'Space Mono',monospace; margin-top:8px;">
        cherche aussi : #spaceinvader${id.toLowerCase().replace('pa_','')}
      </div>
    </div>
  `;

  panel.classList.add('open');

  // Adjust map to not be hidden behind panel
  document.getElementById('map').style.marginRight = '380px';
}

function closeIgPanel() {
  document.getElementById('igPanel').classList.remove('open');
  document.getElementById('map').style.marginRight = '0';
}

// Close panel with Escape key
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeIgPanel();
});

// ===== START =====
init();
</script>

<!-- 
===========================================
HOW TO GET REAL DATA FROM PNOTE.EU
===========================================
Since CORS might block direct browser requests, use this Python script
to scrape the data ONCE and save it locally:

--- save as: scrape_invaders.py ---

import requests
import json
import re

# Method 1: Try JSON endpoints
urls = [
    "https://pnote.eu/projects/invaders/data.json",
    "https://pnote.eu/projects/invaders/map/data.json",
]
for url in urls:
    try:
        r = requests.get(url, timeout=10)
        if r.ok:
            with open("invaders_data.json", "w") as f:
                json.dump(r.json(), f)
            print(f"Saved from {url}")
            break
    except: pass

# Method 2: Scrape the page JS
r = requests.get("https://pnote.eu/projects/invaders/map/")
matches = re.findall(r'let data\s*=\s*(\[.*?\]);', r.text, re.DOTALL)
if matches:
    data = json.loads(matches[0])
    with open("invaders_data.json", "w") as f:
        json.dump(data, f)
    print(f"Extracted {len(data)} invaders")

--- then host locally ---
# python3 -m http.server 8000
# Load invaders_data.json in the app

===========================================
HOW TO GET YOUR FLASH INVADERS UID
===========================================
Option A (Android - ADB):
  adb logcat | grep "space-invaders"
  ‚Üí Ouvre l'app ‚Üí note le uid= dans les logs

Option B (mitmproxy):
  brew install mitmproxy
  mitmweb  
  ‚Üí Configure ton tel pour passer par le proxy
  ‚Üí Ouvre l'app ‚Üí intercepte les requ√™tes api.space-invaders.com
  ‚Üí Le uid est dans les params

Option C: Via pnote.eu
  ‚Üí Va sur https://pnote.eu/projects/invaders/map/
  ‚Üí Param√®tres ‚Üí Flash Invaders ‚Üí Entre ton uid
  ‚Üí Les flashs apparaissent en gris√©
===========================================
-->
</body>
</html>
